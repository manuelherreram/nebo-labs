
This task provisions a small lab environment in AWS using Terraform:

- **Public Bastion** (Amazon Linux 2023) — SSH allowed **only** from your public IP (/32)
- **Private Linux** (Amazon Linux 2023) — no public IP, SSH only allowed from the Bastion SG
- **Private Windows Server 2025** — no public IP, RDP only allowed from the Bastion SG
- **No NAT** (keeps cost low) — private instances have no internet-facing addresses
- All resources are created with Terraform and follow provider best practices (no credentials in code)

---

## What this folder contains

- `providers.tf` — AWS provider (region, default tags)
- `variables.tf` — tunable variables (CIDRs, key paths, instance type, allowed SSH CIDR)
- `main.tf` — VPC, subnets, route tables, security groups, key pairs, EC2 instances (bastion, linux, windows)
- `.gitignore` — ignores state & local secrets
- `terraform.tfvars` — generated by you (contains your public IP /32)

---

## Key points & assumptions

- You have the **AWS CLI** configured with an IAM user (not root).  
- You created two local SSH keys:
  - ED25519 pair for Linux & Bastion: `~/.ssh/nebo_aws` (private) and `~/.ssh/nebo_aws.pub` (public)  
  - RSA pair for Windows: `~/.ssh/nebo_aws_rsa` (private, PEM) and `~/.ssh/nebo_aws_rsa.pub` (public)  
  > Windows AMIs require RSA keys (so the Administrator password can be encrypted). Convert RSA private key to PEM if needed:  
  > `ssh-keygen -p -m PEM -f ~/.ssh/nebo_aws_rsa`

- Keep your private keys safe; do **not** commit them.

---

## How to set your public IP (required)

This writes your public IP as `allowed_ssh_cidr` for the Bastion SG:

```
MYIP=$(curl -s https://ifconfig.me || curl -s https://checkip.amazonaws.com)
echo "allowed_ssh_cidr = \"${MYIP}/32\"" > terraform.tfvars
```
You may also add optional overrides in terraform.tfvars (region, instance_type).
## Terraform workflow (deploy)
```
terraform fmt
terraform init
terraform validate
terraform plan -out plan.out
terraform apply "plan.out"
```
## Outputs shown after apply
- bastion_public_ip — public IPv4 of bastion

- linux_private_ip — private IPv4 of the Linux instance

- windows_private_ip — private IPv4 of the Windows instance

- windows_instance_id— Instance ID (useful to get the password)

## How to connect — step by step
A) SSH to the Bastion (from your laptop)
Ensure your SSH agent has the ED25519 key:

```
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/nebo_aws
Connect to bastion (agent forwarding enabled):
ssh -A -i ~/.ssh/nebo_aws ec2-user@$(terraform output -raw bastion_public_ip)

```
B) From Bastion → Private Linux
While on the bastion shell:

```
ssh ec2-user@$(terraform output -raw linux_private_ip)

```
C) RDP to Windows through an SSH tunnel (from your laptop)
Decrypt the Administrator password (wait a few minutes after Windows boots):


```
WIN_ID=$(terraform output -raw windows_instance_id)
aws ec2 get-password-data --instance-id "$WIN_ID" --priv-launch-key ~/.ssh/nebo_aws_rsa --query 'Password' --output text


```
Save the returned password securely (it contains special characters).

Start the SSH tunnel (Terminal A — keep open):


```
ssh -i ~/.ssh/nebo_aws -L 13389:$(terraform output -raw windows_private_ip):3389 \
    ec2-user@$(terraform output -raw bastion_public_ip)


```
RDP from another terminal (Terminal B):

Install FreeRDP (Fedora):


```
sudo dnf -y install freerdp

```
Run xfreerdp and let it prompt you for the password:


```
xfreerdp /v:127.0.0.1:13389 /u:Administrator

```
At the Domain: prompt press Enter, then paste the Administrator password when asked.

Or use a GUI RDP client connecting to 127.0.0.1:13389.

## Troubleshooting tips
- SSH times out: confirm terraform output -raw bastion_public_ip is correct and terraform.tfvars set your IP. Check SG rules.

- Cannot SSH from bastion to Linux: ensure the Linux SG allows SSH from the Bastion SG (the terraform config uses security group reference).

- Windows password decryption returns empty: wait a few minutes and retry aws ec2 get-password-data. Ensure you used the RSA private key in PEM format.

- xfreerdp certificate warnings: this is normal (self-signed cert). You can trust the certificate interactively or use /cert-ignore.

- RDP auth failure: re-run the get-password-data command to get the latest password and paste it when prompted. Ensure the SSH tunnel is active and forwarding the correct private IP.

## Clean up (avoid charges)
When finished:


```
terraform destroy

``` 
# optionally remove terraform.tfvars if it contains sensitive info

```
rm -f terraform.tfvars

```
## Mapping to NEBo program objectives
- Private compute: demonstrates launching Linux & Windows VMs in a private subnet (no public IPs).

- Secure access: shows bastion-host pattern + agent forwarding for Linux and SSH tunnel for Windows RDP.

- Traffic control: Security Groups enforce instance-level access; route tables + subnet placement enforce network isolation.
